const cluster=require("cluster");if(cluster.isMaster){const e=undefined,r=require("electron").ipcMain,s=require("signale"),t=require("os").cpus().length-1,i=t>7?7:t,n=require("systeminformation");cluster.setupMaster({exec:require("path").join(__dirname,"_multithread.js")});let o=[];cluster.on("fork",e=>{o.push(e.id)});for(let a=0;a<i;a++)cluster.fork();cluster.on("exit",(e,r,t)=>{s.warn(`Worker ${e.process.pid} died (code: ${r}). Restarting...`);const i=o.indexOf(e.id);i>-1&&o.splice(i,1),cluster.fork()}),s.success("Multithreaded controller ready");var lastID=0;function dispatch(e,r,t){if(0===o.length)return;let i=lastID+1;i>=o.length&&(i=0);const n=o[i],a=cluster.workers[n];a?a.send(JSON.stringify({id:r,type:e,arg:t})):s.warn(`Worker ${n} not found/undefined in dispatch. Skipping.`),lastID=i}var queue={};r.on("systeminformation-call",(e,r,t,...i)=>{n[r]?i.length>1||o.length<=0?n[r](...i).then(r=>{e.sender&&e.sender.send("systeminformation-reply-"+t,r)}):(queue[t]=e.sender,dispatch(r,t,i[0])):s.warn("Illegal request for systeminformation")}),cluster.on("message",(e,r)=>{r=JSON.parse(r);try{queue[r.id].isDestroyed()||(queue[r.id].send("systeminformation-reply-"+r.id,r.res),delete queue[r.id])}catch(e){}})}else if(cluster.isWorker)try{const c=require("signale"),l=require("systeminformation");c.info("Multithread worker started at "+process.pid),process.on("message",e=>{try{e=JSON.parse(e),l[e.type]?l[e.type](e.arg).then(r=>{process.send(JSON.stringify({id:e.id,res:r}))}).catch(r=>{c.error(`Worker error in systeminformation call (${e.type}):`,r),process.send(JSON.stringify({id:e.id,res:{error:!0,message:r.message,original:r}}))}):c.error(`Worker received unknown systeminformation type: ${e.type}`)}catch(e){c.error("Worker failed to process message:",e)}})}catch(d){console.error("Worker failed to start:",d),process.exit(1)}