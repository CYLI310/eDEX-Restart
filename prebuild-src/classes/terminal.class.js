class Terminal{constructor(e){if("client"===e.role){if(!e.parentId)throw"Missing options";this.xTerm=require("@xterm/xterm").Terminal;const{AttachAddon:t}=require("@xterm/addon-attach"),{FitAddon:r}=require("@xterm/addon-fit"),{LigaturesAddon:i}=require("@xterm/addon-ligatures"),{WebglAddon:n}=require("@xterm/addon-webgl");this.Ipc=require("electron").ipcRenderer,this.port=e.port||3e3,this.cwd="",this.oncwdchange=()=>{},this._sendSizeToServer=()=>{let e=this.term.cols.toString(),t=this.term.rows.toString();for(;e.length<3;)e="0"+e;for(;t.length<3;)t="0"+t;this.Ipc.send("terminal_channel-"+this.port,"Resize",e,t)};let s=!!window.isTermFilterValidated;!0!==window.isTermFilterValidated&&"object"==typeof window.theme.terminal.colorFilter&&window.theme.terminal.colorFilter.length>0&&(s=window.theme.terminal.colorFilter.every((e,t,r)=>{let i=e.slice(0,e.indexOf("("));switch(i){case"negate":case"grayscale":return r[t]={func:i,arg:[]},!0;case"lighten":case"darken":case"saturate":case"desaturate":case"whiten":case"blacken":case"fade":case"opaquer":case"rotate":case"mix":break;default:return!1}let n=e.slice(e.indexOf("(")+1,e.indexOf(")"));return"number"==typeof Number(n)&&(r[t]={func:i,arg:[Number(n)]},window.isTermFilterValidated=!0,!0)}));let o=require("color"),c;c=s?(e,t)=>{let r=o(e);t=o(t);for(let e=0;e<window.theme.terminal.colorFilter.length;e++)r="mix"===window.theme.terminal.colorFilter[e].func?r[window.theme.terminal.colorFilter[e].func](t,...window.theme.terminal.colorFilter[e].arg):r[window.theme.terminal.colorFilter[e].func](...window.theme.terminal.colorFilter[e].arg);return r.hex()}:(e,t)=>o(e).grayscale().mix(o(t),.3).hex();let l=`rgb(${window.theme.r}, ${window.theme.g}, ${window.theme.b})`;this.term=new this.xTerm({cols:80,rows:24,cursorBlink:window.theme.terminal.cursorBlink||!0,cursorStyle:window.theme.terminal.cursorStyle||"block",allowTransparency:window.theme.terminal.allowTransparency||!1,fontFamily:window.theme.terminal.fontFamily||"Fira Mono",fontSize:window.theme.terminal.fontSize||window.settings.termFontSize||15,fontWeight:window.theme.terminal.fontWeight||"normal",fontWeightBold:window.theme.terminal.fontWeightBold||"bold",letterSpacing:window.theme.terminal.letterSpacing||0,lineHeight:window.theme.terminal.lineHeight||1,scrollback:1500,bellStyle:"none",theme:{foreground:window.theme.terminal.foreground,background:window.theme.terminal.background,cursor:window.theme.terminal.cursor,cursorAccent:window.theme.terminal.cursorAccent,selection:window.theme.terminal.selection,black:window.theme.colors.black||c("#2e3436",l),red:window.theme.colors.red||c("#cc0000",l),green:window.theme.colors.green||c("#4e9a06",l),yellow:window.theme.colors.yellow||c("#c4a000",l),blue:window.theme.colors.blue||c("#3465a4",l),magenta:window.theme.colors.magenta||c("#75507b",l),cyan:window.theme.colors.cyan||c("#06989a",l),white:window.theme.colors.white||c("#d3d7cf",l),brightBlack:window.theme.colors.brightBlack||c("#555753",l),brightRed:window.theme.colors.brightRed||c("#ef2929",l),brightGreen:window.theme.colors.brightGreen||c("#8ae234",l),brightYellow:window.theme.colors.brightYellow||c("#fce94f",l),brightBlue:window.theme.colors.brightBlue||c("#729fcf",l),brightMagenta:window.theme.colors.brightMagenta||c("#ad7fa8",l),brightCyan:window.theme.colors.brightCyan||c("#34e2e2",l),brightWhite:window.theme.colors.brightWhite||c("#eeeeec",l)}});let h=new r;this.term.loadAddon(h),this.term.open(document.getElementById(e.parentId));try{this.term.loadAddon(new n)}catch(e){console.warn("WebGL Addon failed to load",e)}try{let e=new i;this.term.loadAddon(e)}catch(e){console.warn("Ligatures Addon failed to load",e)}this.term.attachCustomKeyEventHandler(e=>(window.keyboard.keydownHandler(e),!0)),document.querySelectorAll(".xterm-helper-textarea").forEach(e=>e.setAttribute("readonly","readonly")),this.term.focus(),this.Ipc.send("terminal_channel-"+this.port,"Renderer startup"),this.Ipc.on("terminal_channel-"+this.port,(e,...t)=>{switch(t[0]){case"New cwd":this.cwd=t[1],this.oncwdchange(this.cwd);break;case"Fallback cwd":this.cwd="FALLBACK |-- "+t[1],this.oncwdchange(this.cwd);break;case"New process":this.onprocesschange&&this.onprocesschange(t[1]);break;default:return}}),this.resendCWD=()=>{this.oncwdchange(this.cwd||null)};let a=e.host||"127.0.0.1",d=this.port;this.socket=new WebSocket("ws://"+a+":"+d),this.socket.onopen=()=>{let e=new t(this.socket);this.term.loadAddon(e),this.fit()},this.socket.onerror=e=>{console.error("Terminal WebSocket error:",e),this.term.write("\r\n[31mTerminal WebSocket Connection Error[0m\r\n")},this.socket.onclose=e=>{this.onclose&&this.onclose(e)},this.lastSoundFX=Date.now(),this.socket.addEventListener("message",e=>{let t=Date.now();if(t-this.lastSoundFX>30&&("false"==window.passwordMode&&window.audioManager.stdout.play(),this.lastSoundFX=t),t-this.lastRefit>1e4&&this.fit(),!window.settings.experimentalGlobeFeatures)return;let r=e.data.match(/((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/g);null!==r&&r.length>=1&&(r=r.filter((e,t,r)=>r.indexOf(e)===t),r.forEach(e=>{window.mods.globe.addTemporaryConnectedMarker(e)}))});let w=document.getElementById(e.parentId);w.addEventListener("wheel",e=>{this.term.scrollLines(Math.round(e.deltaY/10))}),this._lastTouchY=null,w.addEventListener("touchstart",e=>{this._lastTouchY=e.targetTouches[0].screenY}),w.addEventListener("touchmove",e=>{if(this._lastTouchY){let t=e.changedTouches[0].screenY,r=t-this._lastTouchY;this._lastTouchY=t,this.term.scrollLines(-Math.round(r/10))}}),w.addEventListener("touchend",e=>{this._lastTouch=null}),w.addEventListener("touchcancel",e=>{this._lastTouch=null}),document.querySelector(".xterm-helper-textarea").addEventListener("keydown",e=>{"F11"===e.key&&window.settings.allowWindowed&&(e.preventDefault(),window.toggleFullScreen())}),this.fit=()=>{this.lastRefit=Date.now();let{cols:e,rows:t}=h.proposeDimensions(),r,i,n=1,s=0;function o(e,t){return 0==t?e:o(t,e%t)}let c=o(screen.width,screen.height);100===c&&(s=1,n=3),256===c&&(n=2),window.settings.termFontSize<15&&(s-=1),e+=n,t+=s,this.term.cols===e&&this.term.rows===t||this.resize(e,t)},this.resize=(e,t)=>{this.term.resize(e,t),this._sendSizeToServer()},this.write=e=>{this.socket.send(e)},this.writelr=e=>{this.socket.send(e+"\r")},this.clipboard={copy:()=>{if(!this.term.hasSelection())return!1;document.execCommand("copy"),this.term.clearSelection(),this.clipboard.didCopy=!0},paste:()=>{this.write(remote.clipboard.readText()),this.clipboard.didCopy=!1},didCopy:!1}}else{if("server"!==e.role)throw"Unknown purpose";this.Pty=require("node-pty"),this.Websocket=require("ws").Server,this.Ipc=require("electron").ipcMain,this.renderer=null,this.port=e.port||3e3,this._closed=!1,this.onclosed=()=>{},this.onopened=()=>{},this.onresize=()=>{},this.ondisconnected=()=>{},this._disableCWDtracking=!1,this._getTtyCWD=e=>new Promise((t,r)=>{let i=e._pid;switch(require("os").type()){case"Linux":require("fs").readlink(`/proc/${i}/cwd`,(e,i)=>{null!==e?r(e):t(i)});break;case"Darwin":require("child_process").exec(`lsof -a -d cwd -p ${i} | tail -1 | awk '{ for (i=9; i<=NF; i++) printf "%s ", $i }'`,(e,i)=>{null!==e?r(e):t(i.trim())});break;default:r("Unsupported OS")}}),this._getTtyProcess=e=>new Promise((t,r)=>{let i=e._pid;switch(require("os").type()){case"Linux":case"Darwin":require("child_process").exec(`ps -o comm --no-headers --sort=+pid -g ${i} | tail -1`,(e,i)=>{null!==e?r(e):t(i.trim())});break;default:r("Unsupported OS")}}),this._nextTickUpdateTtyCWD=!1,this._nextTickUpdateProcess=!1,this._tick=setInterval(()=>{this._nextTickUpdateTtyCWD&&!1===this._disableCWDtracking&&(this._nextTickUpdateTtyCWD=!1,this._getTtyCWD(this.tty).then(e=>{this.tty._cwd!==e&&(this.tty._cwd=e,this.renderer&&this.renderer.send("terminal_channel-"+this.port,"New cwd",e))}).catch(t=>{if(!this._closed){console.log("Error while tracking TTY working directory: ",t),this._disableCWDtracking=!0;try{this.renderer&&this.renderer.send("terminal_channel-"+this.port,"Fallback cwd",e.cwd||process.env.PWD)}catch(t){}}})),this.renderer&&this._nextTickUpdateProcess&&(this._nextTickUpdateProcess=!1,this._getTtyProcess(this.tty).then(e=>{this.tty._process!==e&&(this.tty._process=e,this.renderer&&this.renderer.send("terminal_channel-"+this.port,"New process",e))}).catch(e=>{if(!this._closed){console.log("Error while retrieving TTY subprocess: ",e);try{this.renderer&&this.renderer.send("terminal_channel-"+this.port,"New process","")}catch(e){}}}))},1e3),this.tty=this.Pty.spawn(e.shell||"bash",e.params.length>0?e.params:"win32"===process.platform?[]:["--login"],{name:e.env.TERM||"xterm-256color",cols:80,rows:24,cwd:e.cwd||process.env.PWD,env:e.env||process.env}),this.tty.onExit((e,t)=>{this._closed=!0,this.onclosed(e,t)}),this.wss=new this.Websocket({port:this.port,clientTracking:!0,verifyClient:e=>!(this.wss.clients.length>=1)}),this.Ipc.on("terminal_channel-"+this.port,(t,...r)=>{switch(r[0]){case"Renderer startup":this.renderer=t.sender,!this._disableCWDtracking&&this.tty._cwd&&this.renderer.send("terminal_channel-"+this.port,"New cwd",this.tty._cwd),this._disableCWDtracking&&this.renderer.send("terminal_channel-"+this.port,"Fallback cwd",e.cwd||process.env.PWD);break;case"Resize":let i=r[1],n=r[2];try{this.tty.resize(Number(i),Number(n))}catch(e){}this.onresized(i,n);break;default:return}}),this.wss.on("connection",e=>{this.onopened(this.tty._pid),e.on("close",(e,t)=>{this.ondisconnected(e,t)}),e.on("message",e=>{this.tty.write(e)}),this.tty.onData(t=>{this._nextTickUpdateTtyCWD=!0,this._nextTickUpdateProcess=!0;try{e.send(t)}catch(e){}})}),this.close=()=>{this.tty.kill(),this._closed=!0}}}}module.exports={Terminal};