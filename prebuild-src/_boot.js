const signale=require("signale"),{app,BrowserWindow,dialog,shell}=require("electron");process.on("uncaughtException",e=>{signale.fatal(e),dialog.showErrorBox("eDEX-UI crashed",e.message||"Cannot retrieve error message."),tty&&tty.close(),extraTtys&&Object.keys(extraTtys).forEach(e=>{null!==extraTtys[e]&&extraTtys[e].close()}),process.exit(1)}),signale.start(`Starting eDEX-UI v${app.getVersion()}`),signale.info(`With Node ${process.versions.node} and Electron ${process.versions.electron}`),signale.info(`Renderer is Chrome ${process.versions.chrome}`);const gotLock=app.requestSingleInstanceLock();gotLock||(signale.fatal("Error: Another instance of eDEX is already running. Cannot proceed."),app.exit(1)),signale.time("Startup");const electron=require("electron");require("@electron/remote/main").initialize();const ipc=electron.ipcMain,path=require("path"),url=require("url"),fs=require("fs"),which=require("which"),Terminal=require("./classes/terminal.class.js").Terminal;var win,tty,extraTtys;ipc.on("log",(e,t,n)=>{signale[t](n)});const settingsFile=path.join(electron.app.getPath("userData"),"settings.json"),shortcutsFile=path.join(electron.app.getPath("userData"),"shortcuts.json"),lastWindowStateFile=path.join(electron.app.getPath("userData"),"lastWindowState.json"),themesDir=path.join(electron.app.getPath("userData"),"themes"),innerThemesDir=path.join(__dirname,"assets/themes"),kblayoutsDir=path.join(electron.app.getPath("userData"),"keyboards"),innerKblayoutsDir=path.join(__dirname,"assets/kb_layouts"),fontsDir=path.join(electron.app.getPath("userData"),"fonts"),innerFontsDir=path.join(__dirname,"assets/fonts");process.env.http_proxy&&delete process.env.http_proxy,process.env.https_proxy&&delete process.env.https_proxy,app.commandLine.appendSwitch("ignore-gpu-blocklist"),app.commandLine.appendSwitch("enable-gpu-rasterization"),app.commandLine.appendSwitch("enable-video-decode");try{fs.mkdirSync(electron.app.getPath("userData")),signale.info(`Created config dir at ${electron.app.getPath("userData")}`)}catch(e){signale.info(`Base config dir is ${electron.app.getPath("userData")}`)}fs.existsSync(settingsFile)||(fs.writeFileSync(settingsFile,JSON.stringify({shell:"win32"===process.platform?"powershell.exe":"bash",shellArgs:"",cwd:electron.app.getPath("userData"),keyboard:"en-US",theme:"tron",termFontSize:15,audio:!0,audioVolume:1,disableFeedbackAudio:!1,clockHours:24,pingAddr:"1.1.1.1",port:3e3,nointro:!1,nocursor:!1,forceFullscreen:!0,allowWindowed:!1,excludeThreadsFromToplist:!0,hideDotfiles:!1,fsListView:!1,experimentalGlobeFeatures:!1,experimentalFeatures:!1},"",4)),signale.info(`Default settings written to ${settingsFile}`)),fs.existsSync(shortcutsFile)||(fs.writeFileSync(shortcutsFile,JSON.stringify([{type:"app",trigger:"Ctrl+Shift+C",action:"COPY",enabled:!0},{type:"app",trigger:"Ctrl+Shift+V",action:"PASTE",enabled:!0},{type:"app",trigger:"Ctrl+Tab",action:"NEXT_TAB",enabled:!0},{type:"app",trigger:"Ctrl+Shift+Tab",action:"PREVIOUS_TAB",enabled:!0},{type:"app",trigger:"Ctrl+X",action:"TAB_X",enabled:!0},{type:"app",trigger:"Ctrl+Shift+S",action:"SETTINGS",enabled:!0},{type:"app",trigger:"Ctrl+Shift+K",action:"SHORTCUTS",enabled:!0},{type:"app",trigger:"Ctrl+Shift+F",action:"FUZZY_SEARCH",enabled:!0},{type:"app",trigger:"Ctrl+Shift+L",action:"FS_LIST_VIEW",enabled:!0},{type:"app",trigger:"Ctrl+Shift+H",action:"FS_DOTFILES",enabled:!0},{type:"app",trigger:"Ctrl+Shift+P",action:"KB_PASSMODE",enabled:!0},{type:"app",trigger:"Ctrl+Shift+I",action:"DEV_DEBUG",enabled:!1},{type:"app",trigger:"Ctrl+Shift+F5",action:"DEV_RELOAD",enabled:!0},{type:"shell",trigger:"Ctrl+Shift+Alt+Space",action:"neofetch",linebreak:!0,enabled:!1}],"",4)),signale.info(`Default keymap written to ${shortcutsFile}`)),fs.existsSync(lastWindowStateFile)||(fs.writeFileSync(lastWindowStateFile,JSON.stringify({useFullscreen:!0},"",4)),signale.info(`Default last window state written to ${lastWindowStateFile}`)),signale.pending("Mirroring internal assets...");try{fs.mkdirSync(themesDir)}catch(e){}fs.readdirSync(innerThemesDir).forEach(e=>{fs.writeFileSync(path.join(themesDir,e),fs.readFileSync(path.join(innerThemesDir,e),{encoding:"utf-8"}))});try{fs.mkdirSync(kblayoutsDir)}catch(e){}fs.readdirSync(innerKblayoutsDir).forEach(e=>{fs.writeFileSync(path.join(kblayoutsDir,e),fs.readFileSync(path.join(innerKblayoutsDir,e),{encoding:"utf-8"}))});try{fs.mkdirSync(fontsDir)}catch(e){}fs.readdirSync(innerFontsDir).forEach(e=>{fs.writeFileSync(path.join(fontsDir,e),fs.readFileSync(path.join(innerFontsDir,e)))});const versionHistoryPath=path.join(electron.app.getPath("userData"),"versions_log.json");var versionHistory=fs.existsSync(versionHistoryPath)?require(versionHistoryPath):{},version=app.getVersion();function createWindow(e){let t;signale.info("Creating window..."),t=isNaN(e.monitor)?electron.screen.getPrimaryDisplay():electron.screen.getAllDisplays()[e.monitor]||electron.screen.getPrimaryDisplay();let{x:n,y:i,width:r,height:s}=t.bounds;r++,s++,(win=new BrowserWindow({title:"eDEX-UI",x:n,y:i,width:r,height:s,show:!1,resizable:!0,movable:e.allowWindowed||!1,fullscreen:e.forceFullscreen||!1,autoHideMenuBar:!0,frame:e.allowWindowed||!1,backgroundColor:"#000000",webPreferences:{devTools:!0,contextIsolation:!1,backgroundThrottling:!1,webSecurity:!0,nodeIntegration:!0,nodeIntegrationInSubFrames:!1,allowRunningInsecureContent:!1,experimentalFeatures:e.experimentalFeatures||!1}})).loadURL(url.format({pathname:path.join(__dirname,"ui.html"),protocol:"file:",slashes:!0})),require("@electron/remote/main").enable(win.webContents),signale.complete("Frontend window created!"),win.show(),e.allowWindowed?require(lastWindowStateFile).useFullscreen||win.setFullScreen(!1):win.setResizable(!1),signale.watch("Waiting for frontend connection...")}void 0===versionHistory[version]?versionHistory[version]={firstSeen:Date.now(),lastSeen:Date.now()}:versionHistory[version].lastSeen=Date.now(),fs.writeFileSync(versionHistoryPath,JSON.stringify(versionHistory,0,2),{encoding:"utf-8"}),app.on("ready",async()=>{signale.pending("Loading settings file...");let e=require(settingsFile);if(signale.pending("Resolving shell path..."),e.shell=await which(e.shell).catch(e=>{throw e}),signale.info(`Shell found at ${e.shell}`),signale.success("Settings loaded!"),!require("fs").existsSync(e.cwd))throw new Error("Configured cwd path does not exist.");const{shellEnv:t}=await import("shell-env");let n=await t(e.shell).catch(e=>{throw e});Object.assign(n,{TERM:"xterm-256color",COLORTERM:"truecolor",TERM_PROGRAM:"eDEX-UI",TERM_PROGRAM_VERSION:app.getVersion()},e.env),signale.pending(`Creating new terminal process on port ${e.port||"3000"}`),tty=new Terminal({role:"server",shell:e.shell,params:e.shellArgs||"",cwd:e.cwd,env:n,port:e.port||3e3}),signale.success("Terminal back-end initialized!"),tty.onclosed=(e,t)=>{tty.ondisconnected=()=>{},signale.complete("Terminal exited",e,t),app.quit()},tty.onopened=()=>{signale.success("Connected to frontend!"),signale.timeEnd("Startup")},tty.onresized=(e,t)=>{signale.info("Resized TTY to ",e,t)},tty.ondisconnected=()=>{signale.error("Lost connection to frontend"),signale.watch("Waiting for frontend connection...")},signale.pending("Starting multithreaded calls controller..."),require("./_multithread.js"),createWindow(e),extraTtys={};let i=e.port||3e3;i=Number(i)+2;for(let e=0;e<4;e++)extraTtys[i+e]=null;ipc.on("ttyspawn",(t,i)=>{let r=null;if(Object.keys(extraTtys).forEach(e=>{null===extraTtys[e]&&null===r&&(extraTtys[e]={},r=e)}),null===r)signale.error("TTY spawn denied (Reason: exceeded max TTYs number)"),t.sender.send("ttyspawn-reply","ERROR: max number of ttys reached");else{signale.pending(`Creating new TTY process on port ${r}`);let i=new Terminal({role:"server",shell:e.shell,params:e.shellArgs||"",cwd:tty.tty._cwd||e.cwd,env:n,port:r});signale.success(`New terminal back-end initialized at ${r}`),i.onclosed=(e,t)=>{i.ondisconnected=()=>{},i.wss.close(),signale.complete(`TTY exited at ${r}`,e,t),extraTtys[i.port]=null,i=null},i.onopened=e=>{signale.success(`TTY ${r} connected to frontend (process PID ${e})`)},i.onresized=()=>{},i.ondisconnected=()=>{i.onclosed=()=>{},i.close(),i.wss.close(),extraTtys[i.port]=null,i=null},extraTtys[r]=i,t.sender.send("ttyspawn-reply","SUCCESS: "+r)}});let r=null,s=null;ipc.on("getThemeOverride",(e,t)=>{e.sender.send("getThemeOverride",r)}),ipc.on("getKbOverride",(e,t)=>{e.sender.send("getKbOverride",s)}),ipc.on("setThemeOverride",(e,t)=>{r=t}),ipc.on("setKbOverride",(e,t)=>{s=t})}),app.on("web-contents-created",(e,t)=>{t.setWindowOpenHandler(({url:e})=>(shell.openExternal(e),{action:"deny"})),t.on("will-navigate",(e,n)=>{n!==t.getURL()&&e.preventDefault()})}),app.on("window-all-closed",()=>{signale.info("All windows closed"),app.quit()}),app.on("before-quit",()=>{tty.close(),Object.keys(extraTtys).forEach(e=>{null!==extraTtys[e]&&extraTtys[e].close()}),signale.complete("Shutting down...")});