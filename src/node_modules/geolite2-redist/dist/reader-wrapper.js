export function wrapReader(dbName, readerInitializer, autoUpdater) {
    // ugly typings, but this is quite the hack so typescript would lose it!
    let reader = {};
    const proxy = new Proxy({}, {
        get: (_, prop) => {
            if (prop === 'close') {
                return (...args) => {
                    autoUpdater.close();
                    reader.close?.(...args);
                };
            }
            return reader[prop];
        },
        set: (_, prop, value) => {
            reader[prop] = value;
            return true;
        }
    });
    return new Promise(resolve => {
        autoUpdater.once('check-ok', async (paths) => {
            const dbPath = paths[dbName];
            reader = await readerInitializer(dbPath);
            setImmediate(() => {
                autoUpdater.on('updated', async (paths) => {
                    const dbPath = paths[dbName];
                    reader = await readerInitializer(dbPath);
                });
            });
            resolve(proxy);
        });
    });
}
